name: Build talloc Direct Compilation

on:
  workflow_dispatch:

env:
  TALLOC_VERSION: '2.4.3'

jobs:
  build-direct:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [x86_64, i686, aarch64, armv7l]
        fail-fast: false
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install cross-compiler for ${{ matrix.arch }}
      run: |
        sudo apt-get update
        sudo apt-get install -y wget build-essential
        
        case "${{ matrix.arch }}" in
          "x86_64")
            sudo apt-get install -y gcc g++ binutils
            ;;
          "i686")
            sudo apt-get install -y gcc-multilib g++-multilib binutils
            ;;
          "aarch64")
            sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu binutils-aarch64-linux-gnu
            ;;
          "armv7l")
            sudo apt-get install -y gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf binutils-arm-linux-gnueabihf
            ;;
        esac
    
    - name: Build talloc directly for ${{ matrix.arch }}
      run: |
        wget https://www.samba.org/ftp/talloc/talloc-${{ env.TALLOC_VERSION }}.tar.gz
        tar xzf talloc-${{ env.TALLOC_VERSION }}.tar.gz
        cd talloc-${{ env.TALLOC_VERSION }}
        
        case "${{ matrix.arch }}" in
          "x86_64")
            CC="gcc"
            AR="ar"
            RANLIB="ranlib"
            CFLAGS="-fPIC -O2 -D_GNU_SOURCE"
            ;;
          "i686")
            CC="gcc"
            AR="ar"
            RANLIB="ranlib"
            CFLAGS="-fPIC -O2 -D_GNU_SOURCE -m32 -D_FILE_OFFSET_BITS=64"
            ;;
          "aarch64")
            CC="aarch64-linux-gnu-gcc"
            AR="aarch64-linux-gnu-ar"
            RANLIB="aarch64-linux-gnu-ranlib"
            CFLAGS="-fPIC -O2 -D_GNU_SOURCE"
            ;;
          "armv7l")
            CC="arm-linux-gnueabihf-gcc"
            AR="arm-linux-gnueabihf-ar"
            RANLIB="arm-linux-gnueabihf-ranlib"
            CFLAGS="-fPIC -O2 -D_GNU_SOURCE"
            ;;
        esac
        
        echo "Building talloc directly for ${{ matrix.arch }} using $CC"
        
        # Compile talloc directly
        $CC $CFLAGS -I. -c talloc.c -o talloc.o
        $AR rcs libtalloc.a talloc.o
        $RANLIB libtalloc.a
        
        # Create install directory
        mkdir -p install/lib
        mkdir -p install/include
        
        # Copy files
        cp libtalloc.a install/lib/
        cp talloc.h install/include/
        
        # Verify
        echo "Build verification for ${{ matrix.arch }}:"
        file install/lib/libtalloc.a
        echo "Build successful for ${{ matrix.arch }}!"
    
    - name: Upload ${{ matrix.arch }} artifacts
      uses: actions/upload-artifact@v4
      with:
        name: talloc-${{ env.TALLOC_VERSION }}-${{ matrix.arch }}
        path: talloc-${{ env.TALLOC_VERSION }}/install/**