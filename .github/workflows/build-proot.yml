name: Build PRoot Multi-arch like Termux

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  build-proot:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: x86_64
            image: ubuntu:22.04
            output: proot-x86_64
          - arch: i386
            image: i386/ubuntu:22.04
            output: proot-x86
          - arch: aarch64
            image: arm64v8/ubuntu:22.04
            output: proot-arm64
          - arch: armv7l
            image: arm32v7/ubuntu:22.04
            output: proot-arm
      fail-fast: false

    steps:
    - name: Checkout PRoot source
      uses: actions/checkout@v4
      with:
        repository: termux/proot
        path: proot-src

    - name: Set up QEMU for multi-arch
      uses: docker/setup-qemu-action@v3

    - name: Build PRoot for ${{ matrix.arch }}
      run: |
        docker run --rm \
          -v $(pwd):/workspace \
          ${{ matrix.image }} \
          bash -c "
          # Install dependencies like Termux
          apt-get update
          apt-get install -y build-essential libtalloc-dev wget git
          
          # Build PRoot
          cd /workspace/proot-src/src
          make -f GNUmakefile clean || true
          make -f GNUmakefile proot
          
          # Verify build
          file proot
          ls -la proot
          chmod +x proot
          
          # Copy to workspace
          cp proot /workspace/proot-${{ matrix.arch }}
          "

    - name: Upload ${{ matrix.arch }} binary
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.output }}
        path: proot-${{ matrix.arch }}
        retention-days: 1

  create-release:
    needs: build-proot
    runs-on: ubuntu-latest
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        pattern: proot-*
        merge-multiple: true

    - name: Get commit info
      id: commit
      run: |
        git clone --depth=1 https://github.com/termux/proot.git proot-temp
        cd proot-temp
        echo "hash=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        echo "full_hash=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
        echo "message<<EOF" >> $GITHUB_OUTPUT
        git log -1 --pretty=%B | head -n 5 >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        echo "author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT

    - name: Create checksums and verify builds
      run: |
        cd artifacts
        echo "=== Build Verification ==="
        for file in proot-*; do
          echo "$file:"
          file "$file" || true
        done
        
        echo "=== Checksums ==="
        sha256sum proot-* > checksums.txt
        cat checksums.txt

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: build-${{ steps.commit.outputs.hash }}
        name: "PRoot Multi-arch Build - ${{ steps.commit.outputs.hash }}"
        body: |
          # PRoot Multi-architecture Build
          
          **Built exactly like Termux does - native compilation for each architecture**
          
          **Source Repository:** [termux/proot](https://github.com/termux/proot)
          
          **Commit:** `${{ steps.commit.outputs.full_hash }}`
          **Author:** ${{ steps.commit.outputs.author }}
          
          **Message:**
          ```
          ${{ steps.commit.outputs.message }}
          ```
          
          **Built Architectures:**
          - x86_64 (Intel/AMD 64-bit)
          - x86 (Intel/AMD 32-bit) 
          - arm64 (ARM 64-bit)
          - arm (ARM 32-bit)
          
          **Build Method:** Native compilation in Docker containers using system libtalloc-dev
          
          **SHA256 Checksums:**
          ```
          ${{ steps.checksums.outputs.content }}
          ```
        files: |
          artifacts/proot-*
          artifacts/checksums.txt