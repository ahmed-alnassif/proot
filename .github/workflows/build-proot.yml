lname: Build TALLOC with NDK

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-talloc:
    runs-on: ubuntu-latest
    
    steps:
    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r25b
        add-to-path: true

    - name: Install basic build tools
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          wget \
          tar \
          python3

    - name: Download and extract talloc
      run: |
        wget https://www.samba.org/ftp/talloc/talloc-2.4.3.tar.gz
        tar xzf talloc-2.4.3.tar.gz
        echo "TALLOC_DIR=$PWD/talloc-2.4.3" >> $GITHUB_ENV

    - name: Build talloc for aarch64 with NDK
      run: |
        cd $TALLOC_DIR
        
        NDK_TOOLCHAIN="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64"
        CC="$NDK_TOOLCHAIN/bin/aarch64-linux-android21-clang"
        SYSROOT="$NDK_TOOLCHAIN/sysroot"
        
        echo "=== Building talloc for aarch64 with NDK ==="
        echo "CC: $CC"
        
        # Use the configure script which will call waf properly
        CC="$CC" \
        CFLAGS="--sysroot=$SYSROOT -fPIC" \
        LDFLAGS="--sysroot=$SYSROOT" \
        ./configure --prefix=$PWD/install-ndk --disable-python --cross-compile
        
        make
        make install

    - name: Verify the build
      run: |
        cd $TALLOC_DIR
        echo "=== Build Verification ==="
        
        if [ -d "install-ndk" ]; then
          echo "✅ Build successful!"
          echo "Install directory contents:"
          find install-ndk -type f -name "*.a" -o -name "*.h" | while read file; do
            echo "  - $file"
            if file "$file" 2>/dev/null | grep -q "ELF\|ar archive"; then
              echo "    ✅ Valid binary"
            fi
          done
          
          # Check if library is ARM64
          if [ -f "install-ndk/lib/libtalloc.a" ]; then
            echo "Library architecture:"
            file install-ndk/lib/libtalloc.a || true
          fi
        else
          echo "❌ Build failed - no install directory"
          exit 1
        fi

    - name: Upload talloc artifacts
      uses: actions/upload-artifact@v4
      with:
        name: talloc-aarch64-ndk
        path: |
          $TALLOC_DIR/install-ndk/
        retention-days: 1