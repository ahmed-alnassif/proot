# .github/workflows/build-proot-static.yml
name: Build Static Proot

on:
  push:
    paths: ['scripts/proot/**']
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'  # Weekly build

env:
  TERMUX_PREFIX: /data/data/com.termux/files/usr

jobs:
  build-proot-static:
    runs-on: ubuntu-latest
    container: termux/package-builder

    steps:
    - name: Checkout termux-packages
      uses: actions/checkout@v4
      with:
        repository: termux/termux-packages
        path: termux-packages

    - name: Checkout proot source
      run: |
        cd termux-packages
        git clone https://github.com/termux/proot.git proot-source

    - name: Setup dynamic patcher
      run: |
        cat > /tmp/dynamic-patch.py << 'EOF'
        #!/usr/bin/env python3
        import re
        import os
        
        def patch_build_sh(content):
            # Update dependencies to include static
            content = re.sub(
                r'TERMUX_PKG_DEPENDS="libtalloc"',
                'TERMUX_PKG_DEPENDS="libtalloc-static, libtalloc"',
                content
            )
            
            # Add static linking flags to pre_configure
            if 'termux_step_pre_configure()' in content:
                static_flags = '''termux_step_pre_configure() {
        # Auto-patched static build flags
        LDFLAGS+=" -static"
        LDFLAGS+=" -Wl,--gc-sections"
        LDFLAGS+=" -ltalloc"
        
        # Performance optimizations
        CFLAGS+=" -O3"
        CFLAGS+=" -flto=thin"
        CFLAGS+=" -fuse-ld=lld"
        CFLAGS+=" -march=armv8.2-a+crypto+dotprod"
        LDFLAGS+=" -flto=thin"
        LDFLAGS+=" -fuse-ld=lld"
        LDFLAGS+=" -Wl,--lto-O3"
        LDFLAGS+=" -Wl,--icf=all"
        
        CPPFLAGS+=" -DARG_MAX=131072"
        CPPFLAGS+=" -DNDEBUG"
        '''
                content = re.sub(
                    r'termux_step_pre_configure\(\) \{.*?\n\}',
                    static_flags,
                    content,
                    flags=re.DOTALL
                )
            
            return content
        
        # Read current build.sh
        with open('termux-packages/packages/proot/build.sh', 'r') as f:
            content = f.read()
        
        # Apply patches
        patched = patch_build_sh(content)
        
        # Write back
        with open('termux-packages/packages/proot/build.sh', 'w') as f:
            f.write(patched)
        
        print("‚úÖ Successfully patched build.sh")
        EOF
        
        python3 /tmp/dynamic-patch.py

    - name: Build proot static
      run: |
        cd termux-packages
        ./build-package.sh proot

    - name: Extract and verify binary
      run: |
        cd termux-packages
        # Extract the built deb
        dpkg-deb -x debs/proot_*.deb /tmp/proot-extract/
        
        # Verify static linking
        echo "üîç Verifying binary..."
        file /tmp/proot-extract/$TERMUX_PREFIX/bin/proot
        ldd /tmp/proot-extract/$TERMUX_PREFIX/bin/proot 2>&1 | grep -q "not a dynamic executable" && \
          echo "‚úÖ Binary is statically linked" || echo "‚ùå Binary is not static"
        
        # Check optimizations
        readelf -p .comment /tmp/proot-extract/$TERMUX_PREFIX/bin/proot

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: proot-static
        path: |
          termux-packages/debs/proot_*.deb
          /tmp/proot-extract/$TERMUX_PREFIX/bin/proot
        retention-days: 30