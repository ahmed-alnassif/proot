name: Build and Release PRoot

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  build-proot:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: aarch64
            ndk_triplet: aarch64-linux-android
            api_level: 21
            output: proot-arm64
          - arch: arm
            ndk_triplet: armv7a-linux-androideabi
            api_level: 21
            output: proot-arm
          - arch: i686
            ndk_triplet: i686-linux-android
            api_level: 21
            output: proot-x86
          - arch: x86_64
            ndk_triplet: x86_64-linux-android
            api_level: 21
            output: proot-x86-64
      fail-fast: false

    steps:
    - name: Checkout PRoot source
      uses: actions/checkout@v4
      with:
        repository: termux/proot
        path: proot-src

    - name: Get commit details
      id: commit-info
      run: |
        cd proot-src
        echo "COMMIT_HASH=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
        echo "COMMIT_SHORT_HASH=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        echo "COMMIT_MESSAGE<<EOF" >> $GITHUB_OUTPUT
        git log -1 --pretty=%B | head -n 10 >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        echo "COMMIT_AUTHOR=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT
        echo "COMMIT_DATE=$(git log -1 --pretty=%cd --date=format:'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r25b
        add-to-path: true

    - name: Install basic build tools
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          file \
          wget \
          git \
          automake \
          libtool \
          pkg-config

    - name: Build talloc with host GCC (for build tools)
      run: |
        wget https://www.samba.org/ftp/talloc/talloc-2.4.3.tar.gz
        tar xzf talloc-2.4.3.tar.gz
        cd talloc-2.4.3
        ./configure --prefix=$PWD/install --disable-python
        make
        make install
        echo "TALLOC_INCLUDE=$PWD/install/include" >> $GITHUB_ENV
        echo "TALLOC_LIB=$PWD/install/lib" >> $GITHUB_ENV

    - name: Set up NDK environment
      run: |
        NDK_TOOLCHAIN="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64"
        CC="$NDK_TOOLCHAIN/bin/${{ matrix.ndk_triplet }}${{ matrix.api_level }}-clang"
        STRIP="$NDK_TOOLCHAIN/bin/llvm-strip"
        OBJCOPY="$NDK_TOOLCHAIN/bin/llvm-objcopy"
        OBJDUMP="$NDK_TOOLCHAIN/bin/llvm-objdump"
        
        echo "CC=$CC" >> $GITHUB_ENV
        echo "STRIP=$STRIP" >> $GITHUB_ENV
        echo "OBJCOPY=$OBJCOPY" >> $GITHUB_ENV
        echo "OBJDUMP=$OBJDUMP" >> $GITHUB_ENV
        echo "CROSS_COMPILE=$NDK_TOOLCHAIN/bin/${{ matrix.ndk_triplet }}-" >> $GITHUB_ENV
        echo "SYSROOT=$NDK_TOOLCHAIN/sysroot" >> $GITHUB_ENV
        echo "NDK_TOOLCHAIN=$NDK_TOOLCHAIN" >> $GITHUB_ENV

    - name: Build talloc for Android (static)
      run: |
        # Use older talloc version that uses configure script
        wget https://www.samba.org/ftp/talloc/talloc-2.3.4.tar.gz
        tar xzf talloc-2.3.4.tar.gz
        cd talloc-2.3.4
        
        # Configure for Android
        ./configure \
          --host=${{ matrix.ndk_triplet }} \
          --enable-static \
          --disable-shared \
          --disable-python \
          --prefix=$PWD/android-install \
          CC="$CC" \
          CFLAGS="--sysroot=$SYSROOT -fPIE"
        
        make
        make install
        echo "ANDROID_TALLOC_INCLUDE=$PWD/android-install/include" >> $GITHUB_ENV
        echo "ANDROID_TALLOC_LIB=$PWD/android-install/lib" >> $GITHUB_ENV

    - name: Add bzero compatibility library
      run: |
        mkdir -p bzero-compat
        cd bzero-compat
        
        # Create bzero.c that implements bzero using memset
        cat > bzero.c << 'EOF'
        #include <string.h>
        void bzero(void *s, size_t n) {
            memset(s, 0, n);
        }
        EOF
        
        # Compile it with NDK
        $CC --sysroot=$SYSROOT -fPIC -c bzero.c -o bzero.o
        $NDK_TOOLCHAIN/bin/llvm-ar rcs libbzero.a bzero.o
        
        echo "BZERO_COMPAT=$PWD" >> $GITHUB_ENV

    - name: Patch PRoot source for Android
      run: |
        cd proot-src/src
        
        # Patch pipe2 usage in ashmem and sysvipc
        sed -i 's/pipe2(\([^,]*\), O_CLOEXEC)/pipe(\1) == 0 \&\& fcntl(\1[0], F_SETFD, FD_CLOEXEC) == 0 \&\& fcntl(\1[1], F_SETFD, FD_CLOEXEC) == 0/g' extension/ashmem/ashmem.c
        sed -i 's/pipe2(\([^,]*\), O_CLOEXEC)/pipe(\1) == 0 \&\& fcntl(\1[0], F_SETFD, FD_CLOEXEC) == 0 \&\& fcntl(\1[1], F_SETFD, FD_CLOEXEC) == 0/g' extension/sysvipc/sysvipc_shm.c
        
        echo "✅ Patched pipe2 for Android compatibility"

    - name: Build PRoot with NDK
      run: |
        cd proot-src/src
        
        # Copy libraries
        cp $ANDROID_TALLOC_LIB/libtalloc.a ./
        cp $BZERO_COMPAT/libbzero.a ./
        
        # Clean previous builds
        make -f GNUmakefile clean || true
        
        echo "=== Build Environment ==="
        echo "CC: $CC"
        echo "CROSS_COMPILE: $CROSS_COMPILE"
        echo "SYSROOT: $SYSROOT"
        echo "ANDROID_TALLOC_INCLUDE: $ANDROID_TALLOC_INCLUDE"
        echo "ANDROID_TALLOC_LIB: $ANDROID_TALLOC_LIB"
        
        # Build PRoot
        make -f GNUmakefile \
          CROSS_COMPILE="$CROSS_COMPILE" \
          CC="$CC" \
          STRIP="$STRIP" \
          OBJCOPY="$OBJCOPY" \
          OBJDUMP="$OBJDUMP" \
          CPPFLAGS="-I$ANDROID_TALLOC_INCLUDE -I$SYSROOT/usr/include -D_FILE_OFFSET_BITS=64" \
          CFLAGS="--sysroot=$SYSROOT -fPIE -pie" \
          LDFLAGS="-L. -L$SYSROOT/usr/lib -fPIE -pie -static-libgcc" \
          LIBS="-ltalloc -lbzero" \
          V=1
        
        if [ -f proot ]; then
          echo "✅ Build successful!"
          file proot
          ls -la proot
          # Test the binary
          if $CC --sysroot=$SYSROOT -o /dev/null -x c - > /dev/null 2>&1 << 'EOF'
            int main() { return 0; }
          EOF; then
            echo "✅ Cross-compiler is working"
          else
            echo "❌ Cross-compiler test failed"
          fi
          chmod +x proot
        else
          echo "❌ Binary not created!"
          echo "=== Directory contents ==="
          ls -la
          echo "=== Available object files ==="
          find . -name "*.o" -type f | head -10
          exit 1
        fi

    - name: Prepare binary for release
      run: |
        mkdir -p release-binaries
        cd proot-src/src
        cp proot ../../release-binaries/${{ matrix.output }}
        chmod +x ../../release-binaries/${{ matrix.output }}

    - name: Upload binary artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.output }}
        path: release-binaries/${{ matrix.output }}
        retention-days: 1

  create-release:
    needs: build-proot
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Download successful artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        pattern: proot-*
        merge-multiple: true

    - name: Check available artifacts
      run: |
        echo "Available artifacts:"
        find artifacts -type f -name "proot-*" | while read file; do
          echo " - $file"
          file "$file" || true
        done
        COUNT=$(find artifacts -type f -name "proot-*" | wc -l)
        echo "Successful builds: $COUNT"
        echo "COUNT=$COUNT" >> $GITHUB_ENV

    - name: Create checksums
      id: checksums
      run: |
        cd artifacts
        find . -name "proot-*" -type f -exec sha256sum {} \; > checksums.txt
        echo "CHECKSUMS_CONTENT<<EOF" >> $GITHUB_OUTPUT
        cat checksums.txt >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Create GitHub Release
      if: env.COUNT > 0
      uses: softprops/action-gh-release@v1
      with:
        tag_name: build-$(date +%Y%m%d-%H%M%S)
        name: "PRoot Build - $(date +%Y-%m-%d)"
        body: |
          # PRoot Binaries Build
          
          **Built with Android NDK for full Android compatibility**
          
          **Source Repository:** [termux/proot](https://github.com/termux/proot)
          
          **Built with all extensions enabled (ashmem, sysvipc, etc.)**
          
          **Target API Level:** 21 (Android 5.0+)
          
          **Statically linked with talloc**
          
          **Built Architectures:**
          ${{ env.COUNT }} out of 4 architectures built successfully
          
          **SHA256 Checksums:**
          ```
          ${{ steps.checksums.outputs.CHECKSUMS_CONTENT }}
          ```
          
          *Automatically built from latest source commit using Android NDK*
        files: |
          artifacts/proot-*
          artifacts/checksums.txt

    - name: Notify if no builds succeeded
      if: env.COUNT == 0
      run: |
        echo "❌ No builds succeeded - check build logs for details"
        exit 1