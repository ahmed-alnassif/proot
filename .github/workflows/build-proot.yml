# .github/workflows/build-proot-static.yml
name: Build Static Proot

on:
  push:
    paths: ['scripts/proot/**']
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'  # Weekly build

jobs:
  build-proot-static:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout termux-packages
      uses: actions/checkout@v4
      with:
        repository: termux/termux-packages
        path: termux-packages

    - name: Setup Ubuntu environment
      run: |
        sudo apt update
        sudo apt install -y \
          git curl wget unzip \
          python3 python3-pip \
          build-essential \
          clang lld

    - name: Setup Termux build environment
      run: |
        cd termux-packages
        ./scripts/setup-ubuntu.sh
        ./scripts/setup-android-sdk.sh

    - name: Patch proot for static build
      run: |
        cd termux-packages
        
        # Create dynamic patch
        cat > patch-proot.py << 'EOF'
        import re
        import os
        
        build_file = "packages/proot/build.sh"
        
        with open(build_file, 'r') as f:
            content = f.read()
        
        # Update dependencies
        content = re.sub(
            r'TERMUX_PKG_DEPENDS="libtalloc"',
            'TERMUX_PKG_DEPENDS="libtalloc-static, libtalloc"',
            content
        )
        
        # Add static flags to pre_configure
        static_flags = '''termux_step_pre_configure() {
    # Static build flags
    LDFLAGS+=" -static"
    LDFLAGS+=" -Wl,--gc-sections"
    LDFLAGS+=" -ltalloc"
    
    # Performance optimizations
    CFLAGS+=" -O3"
    CFLAGS+=" -flto=thin"
    CFLAGS+=" -fuse-ld=lld"
    LDFLAGS+=" -flto=thin"
    LDFLAGS+=" -fuse-ld=lld"
    
    CPPFLAGS+=" -DARG_MAX=131072"
    CPPFLAGS+=" -DNDEBUG"
'''
        
        if 'termux_step_pre_configure()' in content:
            content = re.sub(
                r'termux_step_pre_configure\(\) \{.*?\n\}',
                static_flags + '\n}',
                content,
                flags=re.DOTALL
            )
        
        with open(build_file, 'w') as f:
            f.write(content)
        
        print("Patched build.sh successfully")
        EOF
        
        python3 patch-proot.py

    - name: Build proot
      run: |
        cd termux-packages
        export TERMUX_PKG_MAINTAINER="GitHub Actions"
        ./build-package.sh -a aarch64 proot

    - name: Extract and verify binary
      run: |
        cd termux-packages
        
        # Find the built package
        DEB_FILE=$(ls debs/proot_*_aarch64.deb 2>/dev/null || ls debs/proot_*.deb | head -1)
        
        if [ -z "$DEB_FILE" ]; then
          echo "âŒ No deb file found"
          ls -la debs/
          exit 1
        fi
        
        # Extract binary
        mkdir -p /tmp/proot-extract
        dpkg-deb -x "$DEB_FILE" /tmp/proot-extract/
        
        # Find proot binary
        PROOT_BINARY=$(find /tmp/proot-extract -name proot -type f | head -1)
        
        if [ -z "$PROOT_BINARY" ]; then
          echo "âŒ No proot binary found in package"
          find /tmp/proot-extract -type f
          exit 1
        fi
        
        echo "ðŸ” Binary analysis:"
        file "$PROOT_BINARY"
        echo ""
        echo "ðŸ“¦ Size:"
        ls -lh "$PROOT_BINARY"
        echo ""
        echo "ðŸ”§ Static check:"
        ldd "$PROOT_BINARY" 2>&1 | head -5
        echo ""
        echo "ðŸš€ Performance flags:"
        readelf -p .comment "$PROOT_BINARY" 2>/dev/null || echo "No comment section"

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: proot-static
        path: |
          termux-packages/debs/proot_*.deb
          /tmp/proot-extract/**/proot
        retention-days: 30