name: Build and Release PRoot

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  build-proot:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: aarch64
            host_triplet: aarch64-linux-gnu
            output: proot-arm64
          - arch: arm
            host_triplet: arm-linux-gnueabi
            output: proot-arm
          - arch: i686
            host_triplet: i686-linux-gnu
            output: proot-x86
          - arch: x86_64
            host_triplet: x86_64-linux-gnu
            output: proot-x86-64
      fail-fast: false

    steps:
    - name: Checkout PRoot source
      uses: actions/checkout@v4
      with:
        repository: termux/proot
        path: proot-src

    - name: Get commit details
      id: commit-info
      run: |
        cd proot-src
        echo "COMMIT_HASH=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
        echo "COMMIT_SHORT_HASH=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        echo "COMMIT_MESSAGE<<EOF" >> $GITHUB_OUTPUT
        git log -1 --pretty=%B | head -n 10 >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        echo "COMMIT_AUTHOR=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT
        echo "COMMIT_DATE=$(git log -1 --pretty=%cd --date=format:'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

    - name: Install cross-compilation tools
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          file \
          wget \
          git \
          automake \
          libtool \
          pkg-config \
          python3
        
        # Install architecture-specific cross compilers
        case "${{ matrix.arch }}" in
          aarch64)
            sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
            echo "CC=aarch64-linux-gnu-gcc" >> $GITHUB_ENV
            echo "STRIP=aarch64-linux-gnu-strip" >> $GITHUB_ENV
            echo "OBJCOPY=aarch64-linux-gnu-objcopy" >> $GITHUB_ENV
            echo "OBJDUMP=aarch64-linux-gnu-objdump" >> $GITHUB_ENV
            ;;
          arm)
            sudo apt-get install -y gcc-arm-linux-gnueabi g++-arm-linux-gnueabi
            echo "CC=arm-linux-gnueabi-gcc" >> $GITHUB_ENV
            echo "STRIP=arm-linux-gnueabi-strip" >> $GITHUB_ENV
            echo "OBJCOPY=arm-linux-gnueabi-objcopy" >> $GITHUB_ENV
            echo "OBJDUMP=arm-linux-gnueabi-objdump" >> $GITHUB_ENV
            ;;
          i686)
            sudo apt-get install -y gcc-multilib g++-multilib
            echo "CC=gcc -m32" >> $GITHUB_ENV
            echo "STRIP=strip" >> $GITHUB_ENV
            echo "OBJCOPY=objcopy" >> $GITHUB_ENV
            echo "OBJDUMP=objdump" >> $GITHUB_ENV
            ;;
          x86_64)
            echo "CC=gcc" >> $GITHUB_ENV
            echo "STRIP=strip" >> $GITHUB_ENV
            echo "OBJCOPY=objcopy" >> $GITHUB_ENV
            echo "OBJDUMP=objdump" >> $GITHUB_ENV
            ;;
        esac

    - name: Build talloc for target architecture
      run: |
        wget https://www.samba.org/ftp/talloc/talloc-2.4.3.tar.gz
        tar xzf talloc-2.4.3.tar.gz
        cd talloc-2.4.3
        
        # Build talloc for the target architecture
        if [ "${{ matrix.arch }}" = "i686" ]; then
          ./configure --prefix=$PWD/install --disable-python CFLAGS="-m32" LDFLAGS="-m32"
        elif [ "${{ matrix.arch }}" = "x86_64" ]; then
          ./configure --prefix=$PWD/install --disable-python
        else
          ./configure --host=${{ matrix.host_triplet }} --prefix=$PWD/install --disable-python
        fi
        
        make
        make install
        echo "TALLOC_INCLUDE=$PWD/install/include" >> $GITHUB_ENV
        echo "TALLOC_LIB=$PWD/install/lib" >> $GITHUB_ENV

    - name: Add bzero compatibility library
      run: |
        mkdir -p bzero-compat
        cd bzero-compat
        
        # Create bzero.c that implements bzero using memset
        cat > bzero.c << 'EOF'
        #include <string.h>
        void bzero(void *s, size_t n) {
        memset(s, 0, n);
        }
        EOF
        
        # Compile it with target compiler
        if [ "${{ matrix.arch }}" = "i686" ]; then
          $CC -m32 -fPIC -c bzero.c -o bzero.o
        else
          $CC -fPIC -c bzero.c -o bzero.o
        fi
        
        # Create static library
        ar rcs libbzero.a bzero.o
        echo "BZERO_COMPAT=$PWD" >> $GITHUB_ENV

    - name: Patch all missing includes in PRoot
      run: |
            cd proot-src/src
            
            # Use a more reliable method to add headers
            for file in $(find . -name "*.c" -type f); do
                  echo "Patching $file"
                  
                  # Create a temporary file with headers
                  {
                        echo "#include <string.h>"
                        echo "#include <stdlib.h>" 
                        echo "#include <stdio.h>"
                        echo "#include <strings.h>"
                        echo "#include <unistd.h>"
                        echo "#include <fcntl.h>"
                        cat "$file"
                  } > "${file}.tmp"
                  
                  mv "${file}.tmp" "$file"
            done
            
            echo "✅ Added all standard headers to all C files"

    - name: Patch pipe2 usage in PRoot
      run: |
            cd proot-src/src
            sed -i 's/pipe2(\([^,]*\), O_CLOEXEC)/pipe(\1) == 0 \&\& fcntl(\1[0], F_SETFD, FD_CLOEXEC) == 0 \&\& fcntl(\1[1], F_SETFD, FD_CLOEXEC) == 0/g' extension/sysvipc/sysvipc_shm.c
            echo "✅ Patched pipe2 for Android compatibility"

    - name: Build PRoot with target compiler
      run: |
            cd proot-src/src
            cp $TALLOC_LIB/libtalloc.so.2.4.3 ./libtalloc.a
            cp $BZERO_COMPAT/libbzero.a ./
            make -f GNUmakefile clean || true
            
            # Set CROSS_COMPILE for non-x86_64 architectures
            if [ "${{ matrix.arch }}" = "aarch64" ]; then
              CROSS_COMPILE="aarch64-linux-gnu-"
            elif [ "${{ matrix.arch }}" = "arm" ]; then
              CROSS_COMPILE="arm-linux-gnueabi-"
            else
              CROSS_COMPILE=""
            fi
            
            # Build flags for different architectures
            if [ "${{ matrix.arch }}" = "i686" ]; then
              CFLAGS="-m32"
              LDFLAGS="-m32"
            else
              CFLAGS=""
              LDFLAGS=""
            fi
            
            make -f GNUmakefile \
                  CROSS_COMPILE="$CROSS_COMPILE" \
                  CC="$CC" \
                  STRIP="$STRIP" \
                  OBJDUMP="$OBJDUMP" \
                  OBJCOPY="$OBJCOPY" \
                  CPPFLAGS="-I$TALLOC_INCLUDE -I." \
                  CFLAGS="$CFLAGS" \
                  LDFLAGS="$LDFLAGS -L. -ltalloc -lbzero" \
                  V=1
            if [ -f proot ]; then
                  echo "✅ Build successful!"
                  file proot
                  ls -la proot
                  chmod +x proot
            else
                  echo "❌ Binary not created!"
                  exit 1
            fi

    - name: Prepare binary for release
      run: |
        mkdir -p release-binaries
        cd proot-src/src
        cp proot ../../release-binaries/${{ matrix.output }}
        chmod +x ../../release-binaries/${{ matrix.output }}

    - name: Upload binary artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.output }}
        path: release-binaries/${{ matrix.output }}
        retention-days: 1

  create-release:
    needs: build-proot
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Download successful artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        pattern: proot-*
        merge-multiple: true

    - name: Check available artifacts
      run: |
        echo "Available artifacts:"
        find artifacts -type f -name "proot-*" | while read file; do
          echo " - $file"
          file "$file" || true
        done
        COUNT=$(find artifacts -type f -name "proot-*" | wc -l)
        echo "Successful builds: $COUNT"
        echo "COUNT=$COUNT" >> $GITHUB_ENV

    - name: Create checksums
      id: checksums
      run: |
        cd artifacts
        find . -name "proot-*" -type f -exec sha256sum {} \; > checksums.txt
        echo "CHECKSUMS_CONTENT<<EOF" >> $GITHUB_OUTPUT
        cat checksums.txt >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Get commit info
      id: commit
      run: |
        git clone --depth=1 https://github.com/termux/proot.git proot-temp
        cd proot-temp
        echo "hash=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        echo "full_hash=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
        echo "message<<EOF" >> $GITHUB_OUTPUT
        git log -1 --pretty=%B | head -n 5 >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        echo "author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT
        echo "date=$(git log -1 --pretty=%cd --date=format:'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

    - name: Create GitHub Release
      if: env.COUNT > 0
      uses: softprops/action-gh-release@v1
      with:
        tag_name: build-${{ steps.commit.outputs.hash }}
        name: "PRoot Build - ${{ steps.commit.outputs.hash }}"
        body: |
          # PRoot Binaries Build
          
          **Built with GCC cross-compilers for maximum compatibility**
          
          **Source Repository:** [termux/proot](https://github.com/termux/proot)
          
          **Commit Details:**
          - **Hash:** `${{ steps.commit.outputs.full_hash }}`
          - **Author:** ${{ steps.commit.outputs.author }}
          - **Date:** ${{ steps.commit.outputs.date }}
          - **Message:**
          ```
          ${{ steps.commit.outputs.message }}
          ```
          
          **Built with all extensions enabled (ashmem, sysvipc, etc.)**
          
          **Built Architectures:**
          ${{ env.COUNT }} out of 4 architectures built successfully
          
          **SHA256 Checksums:**
          ```
          ${{ steps.checksums.outputs.CHECKSUMS_CONTENT }}
          ```
          
          *Automatically built from latest source commit using GCC cross-compilers*
        files: |
          artifacts/proot-*
          artifacts/checksums.txt

    - name: Notify if no builds succeeded
      if: env.COUNT == 0
      run: |
        echo "❌ No builds succeeded - check build logs for details"
        exit 1