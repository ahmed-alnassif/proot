name: Build Multi-arch with System Talloc

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-multi-arch:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [amd64, i386, arm64, armhf]
        fail-fast: false
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Enable multi-arch and install talloc
      run: |
        sudo dpkg --add-architecture ${{ matrix.arch }}
        sudo apt-get update
        
        # Install talloc for the target architecture
        case "${{ matrix.arch }}" in
          "amd64")
            sudo apt-get install -y libtalloc-dev:amd64
            ;;
          "i386")
            sudo apt-get install -y libtalloc-dev:i386
            ;;
          "arm64")
            sudo apt-get install -y libtalloc-dev:arm64
            ;;
          "armhf")
            sudo apt-get install -y libtalloc-dev:armhf
            ;;
        esac
        
        # Verify
        pkg-config --cflags talloc
        pkg-config --libs talloc
    
    - name: Build for ${{ matrix.arch }}
      run: |
        case "${{ matrix.arch }}" in
          "amd64")
            CC="gcc"
            TARGET="x86_64-linux-gnu"
            ;;
          "i386")
            CC="gcc -m32"
            TARGET="i686-linux-gnu"
            ;;
          "arm64")
            CC="aarch64-linux-gnu-gcc"
            TARGET="aarch64-linux-gnu"
            ;;
          "armhf")
            CC="arm-linux-gnueabihf-gcc"
            TARGET="arm-linux-gnueabihf"
            ;;
        esac
        
        # Build your project
        $CC -o myapp-${{ matrix.arch }} main.c `pkg-config --cflags --libs talloc`
        
        # Verify binary
        file myapp-${{ matrix.arch }}
    
    - name: Upload ${{ matrix.arch }} binary
      uses: actions/upload-artifact@v4
      with:
        name: myapp-${{ matrix.arch }}
        path: myapp-${{ matrix.arch }}