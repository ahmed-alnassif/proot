name: Build talloc for Multiple Architectures

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  TALLOC_VERSION: '2.4.0'

jobs:
  build-multi-arch:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [x86_64, i686, aarch64, armv7l]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install cross-compilers and QEMU
      run: |
        sudo apt-get update
        sudo apt-get install -y wget build-essential python3 file \
          qemu-user-static binfmt-support
        
        # Install cross-compilers individually
        case "${{ matrix.arch }}" in
          "x86_64")
            sudo apt-get install -y gcc g++
            ;;
          "i686")
            sudo apt-get install -y gcc-multilib g++-multilib
            ;;
          "aarch64")
            sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
            ;;
          "armv7l")
            sudo apt-get install -y gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf
            ;;
        esac
        
        # Enable QEMU for running cross-compiled binaries during configure
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
    
    - name: Download talloc
      run: |
        wget https://www.samba.org/ftp/talloc/talloc-${{ env.TALLOC_VERSION }}.tar.gz
        tar -xzf talloc-${{ env.TALLOC_VERSION }}.tar.gz
    
    - name: Build for ${{ matrix.arch }}
      run: |
        cd talloc-${{ env.TALLOC_VERSION }}
        
        case "${{ matrix.arch }}" in
          "x86_64")
            export CC="gcc"
            export HOST="x86_64-linux-gnu"
            CROSS_COMPILE=""
            ;;
          "i686")
            export CC="gcc"
            export HOST="i686-linux-gnu"
            export CFLAGS="-m32"
            export LDFLAGS="-m32"
            CROSS_COMPILE="--cross-compile"
            ;;
          "aarch64")
            export CC="aarch64-linux-gnu-gcc"
            export HOST="aarch64-linux-gnu"
            CROSS_COMPILE="--cross-compile"
            ;;
          "armv7l")
            export CC="arm-linux-gnueabihf-gcc"
            export HOST="arm-linux-gnueabihf"
            CROSS_COMPILE="--cross-compile"
            ;;
        esac
        
        echo "Building for ${{ matrix.arch }}"
        echo "CC: $CC"
        echo "HOST: $HOST"
        
        # Clean previous build
        make distclean 2>/dev/null || true
        rm -rf bin/ build/ 2>/dev/null || true
        
        # For cross-compilation, use the cross-answers file and skip execution tests
        if [ "${{ matrix.arch }}" = "x86_64" ]; then
          # Native build
          ./configure \
            --disable-python \
            --prefix=$PWD/install/${{ matrix.arch }}
        else
          # Cross-compilation with extensive answers to skip execution tests
          ./configure \
            --host=$HOST \
            --disable-python \
            --prefix=$PWD/install/${{ matrix.arch }} \
            --cross-compile \
            --cross-answers=../android.txt \
            --disable-rpath \
            --bundled-libraries=ALL
        fi
        
        # Build and install
        make -j$(nproc)
        make install
        
        # Verify build
        echo "Build verification for ${{ matrix.arch }}:"
        find install/${{ matrix.arch }} -name "*.a" -o -name "*.so" | xargs file 2>/dev/null || \
        ls -la install/${{ matrix.arch }}/lib/ 2>/dev/null || echo "No library files found"
    
    - name: Package artifacts
      run: |
        cd talloc-${{ env.TALLOC_VERSION }}
        tar -czf ../talloc-${{ env.TALLOC_VERSION }}-${{ matrix.arch }}-linux-gnu.tar.gz -C install/${{ matrix.arch }} .
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: talloc-${{ env.TALLOC_VERSION }}-${{ matrix.arch }}
        path: talloc-${{ env.TALLOC_VERSION }}-${{ matrix.arch }}-linux-gnu.tar.gz