name: Debug TALLOC Build

on:
  workflow_dispatch:
    inputs:
      architecture:
        description: 'Target architecture'
        required: true
        default: 'aarch64'
        type: choice
        options:
        - aarch64
        - arm
        - i686
        - x86_64

jobs:
  debug-talloc:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [${{ github.event.inputs.architecture }}]
    
    steps:
    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r25b
        add-to-path: true

    - name: Install basic build tools
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          file \
          wget \
          git \
          automake \
          libtool \
          pkg-config

    - name: Set NDK environment variables
      run: |
        NDK_TOOLCHAIN="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64"
        
        case "${{ matrix.arch }}" in
          aarch64)
            TRIPLET="aarch64-linux-android"
            ;;
          arm)
            TRIPLET="armv7a-linux-androideabi"
            ;;
          i686)
            TRIPLET="i686-linux-android"
            ;;
          x86_64)
            TRIPLET="x86_64-linux-android"
            ;;
        esac
        
        CC="$NDK_TOOLCHAIN/bin/${TRIPLET}21-clang"
        SYSROOT="$NDK_TOOLCHAIN/sysroot"
        
        echo "CC=$CC" >> $GITHUB_ENV
        echo "SYSROOT=$SYSROOT" >> $GITHUB_ENV
        echo "TRIPLET=$TRIPLET" >> $GITHUB_ENV
        echo "NDK_TOOLCHAIN=$NDK_TOOLCHAIN" >> $GITHUB_ENV

    - name: Download and extract talloc
      run: |
        wget https://www.samba.org/ftp/talloc/talloc-2.4.3.tar.gz
        tar xzf talloc-2.4.3.tar.gz
        echo "TALLOC_DIR=$PWD/talloc-2.4.3" >> $GITHUB_ENV

    - name: Attempt 1 - Build talloc with NDK compiler directly
      run: |
        cd $TALLOC_DIR
        mkdir -p build-attempt1
        cd build-attempt1
        
        echo "=== Attempt 1: Direct NDK compiler ==="
        echo "CC: $CC"
        echo "SYSROOT: $SYSROOT"
        
        ../configure --prefix=$PWD/install --disable-python \
          CC="$CC" \
          CFLAGS="--sysroot=$SYSROOT" \
          LDFLAGS="--sysroot=$SYSROOT"
        
        make || echo "❌ Attempt 1 failed"
        make install || echo "❌ Attempt 1 install failed"

    - name: Attempt 2 - Build talloc with host compiler for target
      run: |
        cd $TALLOC_DIR
        mkdir -p build-attempt2
        cd build-attempt2
        
        echo "=== Attempt 2: Host compiler with --host ==="
        
        case "${{ matrix.arch }}" in
          aarch64)
            HOST="aarch64-linux-android"
            ;;
          arm)
            HOST="arm-linux-androideabi"
            ;;
          i686)
            HOST="i686-linux-android"
            ;;
          x86_64)
            HOST="x86_64-linux-android"
            ;;
        esac
        
        ../configure --prefix=$PWD/install --disable-python \
          --host=$HOST \
          CC="$CC" \
          CFLAGS="--sysroot=$SYSROOT" \
          LDFLAGS="--sysroot=$SYSROOT"
        
        make || echo "❌ Attempt 2 failed"
        make install || echo "❌ Attempt 2 install failed"

    - name: Attempt 3 - Build talloc statically with NDK
      run: |
        cd $TALLOC_DIR
        mkdir -p build-attempt3
        cd build-attempt3
        
        echo "=== Attempt 3: Static build with NDK ==="
        
        ../configure --prefix=$PWD/install --disable-python \
          --enable-static \
          --disable-shared \
          CC="$CC" \
          CFLAGS="--sysroot=$SYSROOT -fPIC" \
          LDFLAGS="--sysroot=$SYSROOT -static"
        
        make || echo "❌ Attempt 3 failed"
        make install || echo "❌ Attempt 3 install failed"

    - name: Attempt 4 - Manual build with NDK
      run: |
        cd $TALLOC_DIR
        mkdir -p build-attempt4
        cd build-attempt4
        
        echo "=== Attempt 4: Manual compilation ==="
        
        # Compile all .c files manually
        for file in $(find ../ -name "*.c" -type f); do
          echo "Compiling $file"
          $CC --sysroot=$SYSROOT -fPIC -c "$file" -I../ -I$SYSROOT/usr/include -o "$(basename $file .c).o" || echo "Failed: $file"
        done
        
        # Create static library
        $NDK_TOOLCHAIN/bin/llvm-ar rcs libtalloc.a *.o || echo "❌ AR failed"
        ls -la *.a || echo "No library created"

    - name: Check results
      run: |
        echo "=== Build Results ==="
        for attempt in 1 2 3 4; do
          echo "Attempt $attempt:"
          if [ -d "$TALLOC_DIR/build-attempt$attempt/install" ]; then
            echo "✅ Success - install directory exists"
            find "$TALLOC_DIR/build-attempt$attempt/install" -name "*.a" -o -name "*.so" | while read file; do
              echo "  - $(basename $file)"
              file "$file" || true
            done
          else
            echo "❌ Failed - no install directory"
          fi
          echo "---"
        done

    - name: Upload build logs
      uses: actions/upload-artifact@v4
      with:
        name: talloc-debug-${{ matrix.arch }}
        path: |
          $TALLOC_DIR/build-*/config.log
          $TALLOC_DIR/build-*/Makefile
        retention-days: 1