name: Debug TALLOC Build

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  debug-talloc:
    runs-on: ubuntu-latest
    
    steps:
    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r25b
        add-to-path: true

    - name: Install cross-compilers
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          file \
          wget \
          git \
          automake \
          libtool \
          pkg-config \
          python3 \
          gcc-aarch64-linux-gnu \
          g++-aarch64-linux-gnu

    - name: Download and extract talloc
      run: |
        wget https://www.samba.org/ftp/talloc/talloc-2.4.3.tar.gz
        tar xzf talloc-2.4.3.tar.gz
        echo "TALLOC_DIR=$PWD/talloc-2.4.3" >> $GITHUB_ENV

    - name: Attempt 1 - Build with NDK compiler
      run: |
        cd $TALLOC_DIR
        #mkdir -p build-ndk
        #cd build-ndk
        
        NDK_TOOLCHAIN="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64"
        CC="$NDK_TOOLCHAIN/bin/aarch64-linux-android21-clang"
        SYSROOT="$NDK_TOOLCHAIN/sysroot"
        
        echo "=== Attempt 1: NDK Compiler ==="
        echo "CC: $CC"
        
        ./configure --prefix=$PWD/install --disable-python \
          CC="$CC" \
          CFLAGS="--sysroot=$SYSROOT" \
          LDFLAGS="--sysroot=$SYSROOT"
        
        make || echo "❌ NDK build failed"
        make install || echo "❌ NDK install failed"

    - name: Attempt 2 - Build with aarch64-linux-gnu compiler
      run: |
        cd $TALLOC_DIR
        #mkdir -p build-aarch64-gcc
        #cd build-aarch64-gcc
        
        echo "=== Attempt 2: aarch64-linux-gnu-gcc ==="
        
        ./configure --prefix=$PWD/install --disable-python \
          --host=aarch64-linux-gnu \
          CC="aarch64-linux-gnu-gcc"
        
        make || echo "❌ aarch64-gcc build failed"
        make install || echo "❌ aarch64-gcc install failed"

    - name: Attempt 3 - Build with host compiler for aarch64 target
      run: |
        cd $TALLOC_DIR
        #mkdir -p build-host-aarch64
        #cd build-host-aarch64
        
        echo "=== Attempt 3: Host GCC for aarch64 ==="
        
        ./configure --prefix=$PWD/install --disable-python \
          --host=aarch64-linux-gnu \
          CC="gcc"
        
        make || echo "❌ Host GCC aarch64 build failed"
        make install || echo "❌ Host GCC aarch64 install failed"

    - name: Check results
      run: |
        echo "=== Build Results for aarch64 ==="
        
        echo "Attempt 1 (NDK):"
        if [ -d "$TALLOC_DIR/build-ndk/install" ]; then
          echo "✅ Success"
          find "$TALLOC_DIR/build-ndk/install" -name "*.a" -o -name "*.so" | while read file; do
            echo "  - $(basename $file)"
            file "$file" || true
          done
        else
          echo "❌ Failed"
        fi
        
        echo "Attempt 2 (aarch64-linux-gnu-gcc):"
        if [ -d "$TALLOC_DIR/build-aarch64-gcc/install" ]; then
          echo "✅ Success"
          find "$TALLOC_DIR/build-aarch64-gcc/install" -name "*.a" -o -name "*.so" | while read file; do
            echo "  - $(basename $file)"
            file "$file" || true
          done
        else
          echo "❌ Failed"
        fi
        
        echo "Attempt 3 (Host GCC aarch64):"
        if [ -d "$TALLOC_DIR/build-host-aarch64/install" ]; then
          echo "✅ Success"
          find "$TALLOC_DIR/build-host-aarch64/install" -name "*.a" -o -name "*.so" | while read file; do
            echo "  - $(basename $file)"
            file "$file" || true
          done
        else
          echo "❌ Failed"
        fi

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: talloc-aarch64-debug
        path: |
          $TALLOC_DIR/build-*/install
        retention-days: 1