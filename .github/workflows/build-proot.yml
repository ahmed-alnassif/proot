name: Test Talloc Docker Build

on:
  workflow_dispatch:
    inputs:
      arch:
        description: 'Architecture to test'
        required: true
        default: 'x86_64'
        type: choice
        options:
        - x86_64
        - i386
        - aarch64
        - armv7l

jobs:
  test-talloc-build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [x86_64, i386, aarch64, armv7l]
      fail-fast: false

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3

    - name: Test talloc build for ${{ matrix.arch }}
      run: |
        echo "Testing talloc build for ${{ matrix.arch }}"
        
        case "${{ matrix.arch }}" in
          "x86_64")
            PLATFORM="linux/amd64"
            ;;
          "i386")
            PLATFORM="linux/386"
            ;;
          "aarch64")
            PLATFORM="linux/arm64"
            ;;
          "armv7l")
            PLATFORM="linux/arm/v7"
            ;;
        esac
        
        echo "Using platform: $PLATFORM"
        
        # Test 1: Simple hello world to verify Docker works
        echo "=== Test 1: Basic Docker functionality ==="
        docker run --rm --platform $PLATFORM ubuntu:22.04 uname -a
        
        # Test 2: Build talloc
        echo "=== Test 2: Building talloc ==="
        docker run --rm --platform $PLATFORM -v $(pwd):/workspace ubuntu:22.04 bash -c "
          set -e
          echo 'Installing dependencies...'
          apt-get update
          apt-get install -y wget build-essential python3
          echo 'Downloading talloc...'
          cd /workspace
          wget https://www.samba.org/ftp/talloc/talloc-2.4.3.tar.gz
          tar xzf talloc-2.4.3.tar.gz
          echo 'Configuring talloc...'
          cd talloc-2.4.3
          ./configure --prefix=/workspace/talloc-install --disable-python
          echo 'Building talloc...'
          make
          echo 'Installing talloc...'
          make install
          echo 'Build completed successfully!'
          ls -la /workspace/talloc-install/
        "
        
        # Verify the build on host
        echo "=== Test 3: Verifying build on host ==="
        if [ -d "talloc-install" ]; then
          echo "✅ Talloc built successfully for ${{ matrix.arch }}"
          ls -la talloc-install/
          echo "Include files:"
          ls -la talloc-install/include/ || echo "No include directory"
          echo "Library files:"
          ls -la talloc-install/lib/ || echo "No lib directory"
        else
          echo "❌ Talloc build failed for ${{ matrix.arch }}"
          exit 1
        fi

    - name: Upload test artifacts
      uses: actions/upload-artifact@v4
      with:
        name: talloc-${{ matrix.arch }}-test
        path: |
          talloc-install/
          talloc-2.4.3/