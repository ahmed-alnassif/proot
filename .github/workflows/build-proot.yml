name: Debug TALLOC Build

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  debug-talloc:
    runs-on: ubuntu-latest
    
    steps:
    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r25b
        add-to-path: true

    - name: Install basic build tools
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          file \
          wget \
          git \
          automake \
          libtool \
          pkg-config \
          python3

    - name: Set NDK environment variables for aarch64
      run: |
        NDK_TOOLCHAIN="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64"
        TRIPLET="aarch64-linux-android"
        CC="$NDK_TOOLCHAIN/bin/${TRIPLET}21-clang"
        SYSROOT="$NDK_TOOLCHAIN/sysroot"
        
        echo "CC=$CC" >> $GITHUB_ENV
        echo "SYSROOT=$SYSROOT" >> $GITHUB_ENV
        echo "TRIPLET=$TRIPLET" >> $GITHUB_ENV
        echo "NDK_TOOLCHAIN=$NDK_TOOLCHAIN" >> $GITHUB_ENV

    - name: Download and extract talloc
      run: |
        wget https://www.samba.org/ftp/talloc/talloc-2.4.3.tar.gz
        tar xzf talloc-2.4.3.tar.gz
        echo "TALLOC_DIR=$PWD/talloc-2.4.3" >> $GITHUB_ENV

    - name: Attempt 1 - Build talloc with NDK using waf
      run: |
        cd $TALLOC_DIR
        mkdir -p build-attempt1
        cd build-attempt1
        
        echo "=== Attempt 1: Waf build with NDK ==="
        echo "CC: $CC"
        echo "SYSROOT: $SYSROOT"
        
        # Use waf build system
        ../configure --prefix=$PWD/install --disable-python \
          --cross-compile \
          --cross-answers=android.txt \
          CC="$CC" \
          CFLAGS="--sysroot=$SYSROOT" \
          LDFLAGS="--sysroot=$SYSROOT"
        
        python3 ../buildtools/bin/waf build || echo "❌ Attempt 1 build failed"
        python3 ../buildtools/bin/waf install || echo "❌ Attempt 1 install failed"

    - name: Attempt 2 - Use older talloc with configure script
      run: |
        # Try older talloc version that uses configure
        wget https://www.samba.org/ftp/talloc/talloc-2.3.4.tar.gz
        tar xzf talloc-2.3.4.tar.gz
        cd talloc-2.3.4
        mkdir -p build
        cd build
        
        echo "=== Attempt 2: Older talloc (2.3.4) with configure ==="
        
        ../configure --prefix=$PWD/install --disable-python \
          --host=aarch64-linux-android \
          --enable-static \
          --disable-shared \
          CC="$CC" \
          CFLAGS="--sysroot=$SYSROOT -fPIC" \
          LDFLAGS="--sysroot=$SYSROOT"
        
        make || echo "❌ Attempt 2 failed"
        make install || echo "❌ Attempt 2 install failed"

    - name: Attempt 3 - Manual static build with NDK
      run: |
        cd $TALLOC_DIR
        mkdir -p build-attempt3
        cd build-attempt3
        
        echo "=== Attempt 3: Manual static compilation ==="
        
        # Find and compile all talloc source files
        find ../lib -name "*.c" -type f | while read file; do
          echo "Compiling $file"
          filename=$(basename "$file" .c)
          $CC --sysroot=$SYSROOT -fPIC -I../ -I$SYSROOT/usr/include -c "$file" -o "${filename}.o" || echo "Failed: $file"
        done
        
        # Create static library
        $NDK_TOOLCHAIN/bin/llvm-ar rcs libtalloc.a *.o || echo "❌ AR failed"
        
        # Create include directory structure
        mkdir -p install/include install/lib
        cp ../talloc.h install/include/
        cp libtalloc.a install/lib/
        
        ls -la install/ || echo "No install created"

    - name: Check results
      run: |
        echo "=== Build Results ==="
        
        # Check Attempt 1 (waf)
        echo "Attempt 1 (waf):"
        if [ -d "$TALLOC_DIR/build-attempt1/install" ]; then
          echo "✅ Success"
          find "$TALLOC_DIR/build-attempt1/install" -name "*.a" -o -name "*.so" | while read file; do
            echo "  - $(basename $file)"
            file "$file" || true
          done
        else
          echo "❌ Failed"
        fi
        
        # Check Attempt 2 (older talloc)
        echo "Attempt 2 (talloc-2.3.4):"
        if [ -d "talloc-2.3.4/build/install" ]; then
          echo "✅ Success"
          find "talloc-2.3.4/build/install" -name "*.a" -o -name "*.so" | while read file; do
            echo "  - $(basename $file)"
            file "$file" || true
          done
        else
          echo "❌ Failed"
        fi
        
        # Check Attempt 3 (manual)
        echo "Attempt 3 (manual):"
        if [ -d "$TALLOC_DIR/build-attempt3/install" ]; then
          echo "✅ Success"
          find "$TALLOC_DIR/build-attempt3/install" -name "*.a" -o -name "*.so" | while read file; do
            echo "  - $(basename $file)"
            file "$file" || true
          done
        else
          echo "❌ Failed"
        fi

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: talloc-aarch64-builds
        path: |
          $TALLOC_DIR/build-*/install
          talloc-2.3.4/build/install
        retention-days: 1