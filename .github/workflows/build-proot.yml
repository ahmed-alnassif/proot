name: Build talloc for Multiple Architectures

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  TALLOC_VERSION: '2.4.3'

jobs:
  build-multi-arch:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [x86_64, i686, aarch64, armv7l]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install cross-compilers
      run: |
        sudo apt-get update
        sudo apt-get install -y wget build-essential python3
        
        # Install cross-compilers based on architecture
        case "${{ matrix.arch }}" in
          "x86_64")
            sudo apt-get install -y gcc g++
            ;;
          "i686")
            sudo apt-get install -y gcc-multilib g++-multilib
            ;;
          "aarch64")
            sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
            ;;
          "armv7l")
            sudo apt-get install -y gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf
            ;;
        esac
    
    - name: Build talloc for ${{ matrix.arch }}
      run: |
        wget https://www.samba.org/ftp/talloc/talloc-${{ env.TALLOC_VERSION }}.tar.gz
        tar xzf talloc-${{ env.TALLOC_VERSION }}.tar.gz
        cd talloc-${{ env.TALLOC_VERSION }}
        
        # Set compiler and flags based on architecture
        case "${{ matrix.arch }}" in
          "x86_64")
            export CC="gcc"
            export CFLAGS=""
            export HOST="x86_64-linux-gnu"
            CONFIGURE_FLAGS=""
            ;;
          "i686")
            export CC="gcc"
            export CFLAGS="-m32"
            export LDFLAGS="-m32"
            export HOST="i686-linux-gnu"
            CONFIGURE_FLAGS="--host=$HOST --cross-compile --cross-answers=../android.txt"
            ;;
          "aarch64")
            export CC="aarch64-linux-gnu-gcc"
            export CFLAGS=""
            export HOST="aarch64-linux-gnu"
            CONFIGURE_FLAGS="--host=$HOST --cross-compile --cross-answers=../android.txt"
            ;;
          "armv7l")
            export CC="arm-linux-gnueabihf-gcc"
            export CFLAGS=""
            export HOST="arm-linux-gnueabihf"
            CONFIGURE_FLAGS="--host=$HOST --cross-compile --cross-answers=../android.txt"
            ;;
        esac
        
        echo "Building for ${{ matrix.arch }} with CC=$CC"
        echo "Configure flags: $CONFIGURE_FLAGS"
        
        # Configure and build
        ./configure --prefix=$PWD/install --disable-python $CONFIGURE_FLAGS
        
        make
        make install
        
        # Set environment variables for this step
        echo "TALLOC_INCLUDE_${{ matrix.arch }}=$PWD/install/include" >> $GITHUB_ENV
        echo "TALLOC_LIB_${{ matrix.arch }}=$PWD/install/lib" >> $GITHUB_ENV
        
        # Verify the build
        echo "Build verification:"
        file install/lib/libtalloc.* || ls -la install/lib/
    
    - name: Package and upload ${{ matrix.arch }} artifacts
      run: |
        cd talloc-${{ env.TALLOC_VERSION }}
        tar -czf ../talloc-${{ env.TALLOC_VERSION }}-${{ matrix.arch }}-linux-gnu.tar.gz -C install .
    
    - name: Upload ${{ matrix.arch }} artifacts
      uses: actions/upload-artifact@v4
      with:
        name: talloc-${{ env.TALLOC_VERSION }}-${{ matrix.arch }}
        path: talloc-${{ env.TALLOC_VERSION }}-${{ matrix.arch }}-linux-gnu.tar.gz